name: E2E (Maestro)

on:
    pull_request:
        branches: [main]

jobs:
    maestro:
        runs-on: ubuntu-latest
        timeout-minutes: 30

        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Set up Java
              uses: actions/setup-java@v4
              with:
                  distribution: temurin
                  java-version: 17

            - name: Build debug APK
              run: ./gradlew :app:assembleDebug

            - name: Install Maestro
              run: |
                  curl -Ls "https://get.maestro.mobile.dev" | bash
                  echo "$HOME/.maestro/bin" >> $GITHUB_PATH

            - name: Run emulator + Maestro test
              uses: reactivecircus/android-emulator-runner@v2
              with:
                  api-level: 34
                  target: google_apis
                  arch: x86_64
                  profile: Pixel_6
                  disable-animations: true
                  script: |
                      adb shell pm clear com.nkot117.smartgo.debug || true
                      adb install -r app/build/outputs/apk/debug/app-debug.apk
                      maestro test maestro/smoke.yaml
